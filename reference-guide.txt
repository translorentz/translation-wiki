# Translation Wiki — Reference Guide for Claude Code Sessions
#
# This file provides structured, up-to-date reference information for
# Claude Code sessions and subagents. Always read this file at the start
# of a session to understand the current state of the project.
#
# Last updated: 2026-01-23 (Session 3)

================================================================================
## PROJECT IDENTITY
================================================================================

Name: Deltoi
Domain: https://deltoi.com
GitHub: https://github.com/translorentz/translation-wiki.git
Branch: main (single-branch workflow, auto-deploys to Vercel on push)

================================================================================
## CURRENT DEPLOYMENT STATUS
================================================================================

Platform: Vercel (auto-deploys from GitHub main branch)
Database: Neon PostgreSQL (free tier)
Domain: deltoi.com (custom domain on Vercel)
Latest deploy: 2026-01-23, commit b50ba01

Environment variables (set in Vercel dashboard):
- DATABASE_URL — Neon connection string
- AUTH_SECRET — random base64 secret
- AUTH_URL — should be https://deltoi.com (NOTE: was translation-wiki.vercel.app, needs update)
- DEEPSEEK_API_KEY — for server-side translation features

Known issue: AUTH_URL env var on Vercel may still be set to
translation-wiki.vercel.app instead of https://deltoi.com. User should
update this in Vercel dashboard → Settings → Environment Variables.

================================================================================
## TECH STACK (ACTUAL, NOT PLANNED)
================================================================================

- Next.js 16.1.4 (App Router, Turbopack)
- TypeScript
- React 19
- Tailwind CSS
- Shadcn UI components
- tRPC v11 (fetchRequestHandler, createCaller for RSC)
- Drizzle ORM (postgres.js driver)
- NextAuth.js v5 beta (JWT strategy, credentials provider)
- PostgreSQL (Neon, cloud)
- DeepSeek V3.2 API (deepseek-chat) for AI translations
- Vitest + @testing-library/react (testing)

================================================================================
## DATABASE STATE
================================================================================

Schema synced via: `pnpm db:push` (drizzle-kit push, NOT migrations)

Tables:
- users, languages, authors, texts, chapters
- translations, translation_versions, endorsements

Current data:
- 4 languages: zh (Classical Chinese), grc (Koine Greek), la (Latin), en (English)
- 2 authors seeded: Zhu Xi (朱熹), Constantine VII
- 2 texts seeded: Zhu Zi Yu Lei (140 chapters), De Ceremoniis (7 chapters)
- 1 text NOT yet seeded: Chuanxilu / 傳習錄 (data in data/processed/chuanxilu/)

Translation coverage:
- ZZYL: chapters 1-3 translated (of 140)
- Ceremonialis: chapters 1, 3 translated (of 7)
- Chuanxilu: 3 chapters with translations in data/processed/ but NOT in DB

To sync schema after code changes:
  set -a && source .env.local && set +a && pnpm db:push

To seed/re-seed:
  pnpm db:seed

================================================================================
## TRANSLATION API DETAILS
================================================================================

Provider: DeepSeek (OpenAI-compatible API)
Model: deepseek-chat (V3.2)
Base URL: https://api.deepseek.com
Max output: 8192 tokens
Cost: $0.28/M input, $0.42/M output

Batching strategy (language-aware):
- Classical Chinese (zh): MAX_CHARS_PER_BATCH = 1500 (very dense, 1 char ~ 3-5 English words)
- Greek (grc): MAX_CHARS_PER_BATCH = 6000 (moderate density)
- Latin (la): MAX_CHARS_PER_BATCH = 6000

Script: scripts/translate-batch.ts
Config: src/server/translation/client.ts (OpenAI SDK with DeepSeek baseURL)

IMPORTANT: Do NOT keep translation content in Claude Code context.
Write translations directly to the database via the translate-batch script.

================================================================================
## KEY FILE LOCATIONS
================================================================================

### App pages
src/app/page.tsx                                    — Home page
src/app/(wiki)/texts/page.tsx                       — Browse all texts
src/app/(wiki)/[lang]/[author]/[text]/page.tsx      — Text index/TOC
src/app/(wiki)/[lang]/[author]/[text]/[chapter]/page.tsx — Chapter view
src/app/(wiki)/[lang]/[author]/[text]/[chapter]/edit/page.tsx — Edit page
src/app/(wiki)/admin/users/page.tsx                 — Admin user mgmt
src/app/(wiki)/search/page.tsx                      — Search page
src/app/(auth)/login/page.tsx                       — Login
src/app/(auth)/register/page.tsx                    — Register

### Components
src/components/interlinear/InterlinearViewer.tsx     — Two-column text display
src/components/interlinear/ParagraphPair.tsx         — Single paragraph row
src/components/editor/TextEditor.tsx                 — Translation editor
src/components/navigation/CategoryBrowser.tsx        — Language→Author→Text nav
src/components/navigation/TableOfContents.tsx        — Chapter list sidebar
src/components/endorsement/EndorseButton.tsx         — Endorsement toggle
src/components/history/                             — Version history/diff
src/components/home/FeaturedTexts.tsx               — Home page featured texts

### Server
src/server/db/schema.ts                             — Drizzle schema (all tables)
src/server/db/index.ts                              — DB client
src/server/trpc/init.ts                             — tRPC setup + context
src/server/trpc/routers/texts.ts                    — Text listing queries
src/server/trpc/routers/translations.ts             — Translation CRUD
src/server/trpc/routers/users.ts                    — User management
src/server/auth/index.ts                            — NextAuth config
src/server/translation/client.ts                    — DeepSeek API client

### Scripts
scripts/seed-db.ts                                  — Seed DB from processed data
scripts/translate-batch.ts                          — AI translation batch runner
scripts/acquire-ctext.ts                            — Fetch from ctext.org
scripts/acquire-archive.ts                          — Fetch from Internet Archive
scripts/process-texts.ts                            — Clean raw → processed
scripts/process-chuanxilu.ts                        — Process Chuanxilu text
scripts/fix-chapter-titles.ts                       — Add English to chapter titles

### Data
data/processed/zhuziyulei/chapter-NNN.json          — ZZYL source paragraphs
data/processed/ceremonialis/chapter-NNN.json        — Ceremonialis source
data/processed/chuanxilu/chapter-N.json             — Chuanxilu source
data/processed/chuanxilu/chapter-N-translation.json — Chuanxilu translations
data/raw/                                           — (gitignored) raw downloads

### Config
drizzle.config.ts                                   — Drizzle ORM config
next.config.ts                                      — Next.js config
tailwind.config.ts                                  — Tailwind config
vitest.config.mts                                   — Test config
.env.local                                          — Local env (gitignored)
.env.example                                        — Env template (committed)

### Reference files (for Claude Code sessions)
CLAUDE.md                                           — Project architecture & conventions
scratch-notes.txt                                   — Session-by-session working notes
reference-guide.txt                                 — THIS FILE: structured quick reference
communications-to-the-User.txt                      — Implementation plan & deployment guide

================================================================================
## IMPLEMENTATION STATUS BY PHASE
================================================================================

Phase 1 (Scaffolding):        COMPLETE
Phase 2 (Text Acquisition):   COMPLETE (ZZYL + Ceremonialis + Chuanxilu data)
Phase 3 (Reading UI):          COMPLETE
Phase 4 (Editing/Versioning): COMPLETE
Phase 5 (Endorsements):       COMPLETE
Phase 6 (AI Translation):     COMPLETE (infrastructure; most chapters untranslated)
Phase 7 (Search/Polish):      PARTIAL (search page exists, SEO metadata added)
Phase 8 (Deployment):         COMPLETE (live at deltoi.com)

================================================================================
## REMAINING WORK (PRIORITY ORDER)
================================================================================

1. Update AUTH_URL on Vercel to https://deltoi.com
2. Seed Chuanxilu (傳習錄) into the database
3. Run AI translations for remaining chapters (~137 ZZYL + 5 Ceremonialis)
4. Responsive design polish (mobile stacking for interlinear viewer)
5. Error boundaries and loading skeletons
6. Full-text search improvements (currently basic)
7. Migrate "middleware" to "proxy" convention (Next.js 16 deprecation)
8. Upgrade NextAuth from beta to stable when available

================================================================================
## CONVENTIONS & RULES
================================================================================

1. Schema changes: edit src/server/db/schema.ts, then run `pnpm db:push`
2. Never use migrations in dev — use db:push (schema is already in production via push)
3. Translations are append-only versions — never mutate TranslationVersion rows
4. Paragraph indices must match between source and translation
5. Source texts are immutable after seeding
6. URLs are human-readable slugs: /[lang]/[author]/[text]/[chapter]
7. Chinese text uses Noto Serif CJK font; Greek uses polytonic-capable serif
8. All text content is UTF-8 NFC normalized
9. DeepSeek (not Anthropic/Claude) is the translation API — uses OpenAI SDK
10. Keep scratch-notes.txt and reference-guide.txt updated every session

================================================================================
## COMMON COMMANDS
================================================================================

# Development
pnpm dev                          # Start dev server (localhost:3000)
pnpm build                        # Production build (also used by Vercel)
pnpm lint                         # ESLint
pnpm typecheck                    # tsc --noEmit

# Database
set -a && source .env.local && set +a   # Load env vars for CLI tools
pnpm db:push                      # Sync schema to Neon
pnpm db:seed                      # Seed texts into DB
pnpm db:studio                    # Drizzle Studio GUI

# Translation
pnpm translate:batch              # Run AI translations (needs DEEPSEEK_API_KEY)

# Git & Deploy
git push origin main              # Triggers Vercel auto-deploy
gh api repos/translorentz/translation-wiki/deployments --jq '.[0]'  # Check deploy

================================================================================
## KNOWN ISSUES
================================================================================

- Next.js 16 "middleware" deprecation warning (non-blocking, still works)
- NextAuth v5 beta (5.0.0-beta.30) — no stable release yet
- AUTH_URL on Vercel may still reference translation-wiki.vercel.app
- Only 5/147 chapters have AI translations
- Chuanxilu text data exists but is not seeded into the database
- CLAUDE.md still references @anthropic-ai/sdk in some places (code uses DeepSeek)
