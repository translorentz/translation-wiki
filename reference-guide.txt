# Translation Wiki — Reference Guide for Claude Code Sessions
#
# This file provides structured, up-to-date reference information for
# Claude Code sessions and subagents. Always read this file at the start
# of a session to understand the current state of the project.
#
# Last updated: 2026-01-24 (Session 19)

================================================================================
## PROJECT IDENTITY
================================================================================

Name: Deltoi
Domain: https://deltoi.com
GitHub: https://github.com/translorentz/translation-wiki.git
Branch: main (single-branch workflow, auto-deploys to Vercel on push)

================================================================================
## CURRENT DEPLOYMENT STATUS
================================================================================

Platform: Vercel (auto-deploys from GitHub main branch)
Database: Neon PostgreSQL (free tier)
Domain: deltoi.com (custom domain on Vercel)
Latest deploy: 2026-01-24, commit 7fbe9c1 (fix search to match text titles and author names)

Environment variables (set in Vercel dashboard):
- DATABASE_URL — Neon connection string
- AUTH_SECRET — random base64 secret
- AUTH_URL — should be https://deltoi.com (NOTE: was translation-wiki.vercel.app, needs update)
- DEEPSEEK_API_KEY — for server-side translation features

Known issues:
- AUTH_URL env var on Vercel may still be set to
  translation-wiki.vercel.app instead of https://deltoi.com. User should
  update this in Vercel dashboard → Settings → Environment Variables.
- Search: FIXED (agent a687c60, pushed). Now searches texts.title + authors.name
  with ILIKE substring matching. UI shows "Texts" and "Chapters" sections.

================================================================================
## TECH STACK (ACTUAL, NOT PLANNED)
================================================================================

- Next.js 16.1.4 (App Router, Turbopack)
- TypeScript
- React 19
- Tailwind CSS
- Shadcn UI components
- tRPC v11 (fetchRequestHandler, createCaller for RSC)
- Drizzle ORM (postgres.js driver)
- NextAuth.js v5 beta (JWT strategy, credentials provider)
- PostgreSQL (Neon, cloud)
- DeepSeek V3.2 API (deepseek-chat) for AI translations (zh, grc, la)
- Google Gemini 2.5 Flash (@google/genai SDK) for Tamil translations
- Vitest + @testing-library/react (testing)

================================================================================
## DATABASE STATE
================================================================================

Schema synced via: `pnpm db:push` (drizzle-kit push, NOT migrations)

Tables:
- users, languages, authors, texts, chapters
- translations, translation_versions, endorsements

Current data:
- 7 languages: zh (Classical Chinese), grc (Koine Greek), la (Latin), en (English), ta (Tamil), it (Italian), hy (Armenian)
- 26 authors seeded: Zhu Xi, Constantine VII, Wang Yangming, Cassiodorus,
  Henry of Settimello, Erchempert, Hugo Falcandus, Yuan Shu, Huangdi (trad.),
  Theodore Prodromos, Wilhelm Wagner, Guliang Chi, Mudathirumaran, Ban Gu,
  Zheng Xuan, Zhou Court Scribes, Ying Shao, Huangfu Mi, Nandikkalambakam Poets,
  Anonymous (Diognetus), Zosimus, Anonymous (Soph. Elenchi), Eustathius of Thessalonica,
  Raffi (Armenian), Perch Proshyan (Armenian), Arshagouhi Teotig (Armenian)
- 25 texts seeded (naming convention: "English Name (Transliteration)"):
  - Classified Conversations of Master Zhu (Zhu Zi Yu Lei) — 140 chapters, zh
  - On the Ceremonies of the Byzantine Court — 7 chapters, grc
  - Instructions for Practical Living (Chuan Xi Lu) — 3 chapters, zh
  - On the Soul — 18 chapters, la
  - Elegy on Misfortune — 4 chapters, la (textType=poetry)
  - History of the Lombards of Benevento — 82 chapters, la
  - The Book of the Kingdom of Sicily — 56 chapters, la
  - Narratives from the Comprehensive Mirror (Tongjian Jishi Benmo) — 45 chapters, zh
  - Poems of Poor Prodromos (Ptochoprodromika) — 2 chapters, grc (textType=poetry)
  - The Yellow Emperor's Classic of Medicine (Huang Di Nei Jing) — 55 chapters, zh
  - Medieval Greek Poems (Carmina Graeca Medii Aevi) — 21 chapters, grc (textType=poetry)
  - Commentary of Guliang (Guliang Zhuan) — 12 chapters, zh
  - The War-Bard's Guide (Porunararruppadai) — 1 chapter, ta (textType=poetry)
  - Comprehensive Discussions in the White Tiger Hall (Baihu Tong) — 43 chapters, zh
  - Biographies of Lofty Scholars (Gaoshi Zhuan) — 4 chapters, zh
  - Ceremonies and Rites (Yi Li) — 17 chapters, zh
  - Lost Book of Zhou (Yi Zhou Shu) — 62 chapters, zh (commentary in [brackets])
  - Comprehensive Meaning of Customs (Fengsu Tongyi) — 11 chapters, zh
  - The Anthology of Nandi (Nandikkalambakam) — 114 chapters, ta (textType=poetry)
  - Udayanakumara Kaviyam — 6 chapters, ta (textType=poetry) [NEW — seeded by agent a9ce61b]
  - Record of Daily Knowledge (Rizhilu) — 32 chapters, zh [NEW — agent a400ec2]
  - Diary of the City of Rome (Diarium Urbis Romae) — 66 chapters, it [NEW — Session 18]

Recently seeded (Session 12 — 2026-01-24):
  - Epistle to Diognetus — 12 chapters, grc, prose (author: Anonymous (Diognetus))
  - New History (Historia Nova) — 287 chapters, grc, prose (author: Zosimus)
  - Paraphrase on Sophistical Refutations — 35 chapters, grc, prose (author: Anonymous)
  Translation workers: affd974 (12ch), a21b76e (287ch), af2cefd (35ch) — DeepSeek

Recently seeded (Session 13 — 2026-01-24):
  - Commentary on the Odyssey — 25 chapters, grc, prose (author: Eustathius of Thessalonica)
    Dual-agent pipeline: Round 1 C+ → Round 2 B+ (both volumes), Reviewer SATISFIED
    Combined: 6,146 paragraphs, 3.3M characters, 94.7-97.5% Greek
    Translation: 3 workers (a58c5f4 ch0-8, aa2274c ch9-16, a05fbf7 ch17-24)
    Source: data/difficult_extra_processing/ (2 volumes OCR)
    Pipeline: scripts/lib/eustathius/ (6 modules)
    Docs: docs/eustathius-r2-collaboration.md

Translation coverage (Session 13 — updated 2026-01-24):
- ZZYL: 140/140 COMPLETE
- Ceremonialis: 7/7 COMPLETE
- Chuanxilu: 3/3 COMPLETE
- De Anima: 18/18 COMPLETE
- Elegia: 4/4 COMPLETE
- Lombards: 82/82 COMPLETE
- Regno: 56/56 COMPLETE
- Tongjian: 42/45 (~93%) — workers b83ad01, b76003b still running
- Ptochoprodromos: 2/2 COMPLETE
- HDNJ: 55/55 COMPLETE
- Carmina Graeca: 21/21 COMPLETE
- Guliang Zhuan: 12/12 COMPLETE
- The War-Bard's Guide (Porunararruppadai): 1/1 COMPLETE (v3: editorial clarification)
- Baihu Tong: 43/43 COMPLETE
- Gaoshi Zhuan: 4/4 COMPLETE
- Yi Li: 17/17 COMPLETE
- Yi Zhou Shu: 62/62 COMPLETE (commentary in [brackets] preserved)
- Fengsu Tongyi: 11/11 COMPLETE
- Nandikkalambakam: IN PROGRESS (Stage 1: 114/114 DONE; Stage 2 DONE; Stage 3 retranslating — agent aa88334)
- Udayanakumara Kaviyam: Stage 1 COMPLETE (6/6 chapters translated — agent a9ce61b)
- Yashodhara Kaviyam: IN PROGRESS (Stage 1 — agent a1cae1c processing + translating)
- Diognetum: 12/12 COMPLETE (agent affd974, zero errors)
- Historia Nova: 174/287 (~61%) — 3 workers running (a21b76e, a9d67d7, a63aef9 at ch255+)
- Sophistici Elenchi: 35/35 COMPLETE (agent af2cefd, zero errors)
- Eustathius Odyssey Commentary: 3/25 translated (ch0,17,18) — 3 new workers (ab5dae1 ch1-8, a4043fb ch9-16, afff370 ch19-24)
  NOTE: Previous workers used wrong slug. Correct slug is `eustathius-odyssey` (NOT eustathius-odyssey-commentary)
- Hesiod Theogony Exegesis: REGROUPED 109→13 chapters, 13/13 COMPLETE (agent adb2433)
- Periplus Maris Exteri: 31/31 COMPLETE
- Periplus Maris Interni: 6/6 COMPLETE
- Artemidori Geographia: 3/3 COMPLETE
- Kongzi Jiayu: 80/80 COMPLETE
- Eustathius Odyssey Commentary: 10/27 translated (agents ab5dae1, a4043fb, afff370)
- Diarium Urbis Romae: 66/66 COMPLETE (Session 19, paragraph segmentation v2 applied)
- Rizhilu: 0/32 IN PROGRESS (4 workers running, agent a400ec2)

Armenian Initiative (Session 20) — 6 texts, ~5 MB total:
  Language: hy (Armenian), 19th-20th century literary Armenian
  Translation: DeepSeek V3 (Gemini blocked due to historical violence content)
  Sample review: Kaitser ch1 → Grade A-
  Active agents (7 total):
  - a9cd5db: Kaitser (Raffi) chapters 1-38 — processing + translating
  - a0a5d32: Kaitser (Raffi) chapters 39-76 — processing + translating
  - a85a667: Anna Saroyan (Perch Proshyan) — processing + translating
  - a1babe9: Arshagouhi Teotig memoir (1909 massacre) — processing + translating
  - a28b9b8: Khorhrdavor Miandznuhi (12 files, diary format) — processing + translating
  - afc0b52: Yerkir Nairi (5 files, 3-part novel) — processing + translating
  - a773dc8: Samvel (Raffi, 41 chapters, 3 books) — processing + translating
  Texts:
  - Kaitser (The Spark) — 76 chapters, ~1.5 MB, autobiographical novel by Raffi
  - Anna Saroyan — epistolary novel by Perch Proshyan, ~175 KB
  - Arshagouhi Teotig memoir — 1909 Adana massacre eyewitness, ~393 KB
  - Khorhrdavor Miandznuhi — diary format, 12 files, ~468 KB
  - Yerkir Nairi (Land of Nairi) — 3-part novel, ~619 KB
  - Samvel — historical novel (4th-c. Armenia), 41 chapters, ~1.8 MB, by Raffi
  Files: scripts/translate-armenian.ts, docs/armenian-*.md

  Key findings:
  - Gemini 2.5 Flash blocks Armenian historical content (PROHIBITED_CONTENT)
  - DeepSeek max_tokens limit is 8192 (fixed in translate-armenian.ts)
  - Raw Armenian files correct; "delays" substitution in code/docs (see docs/armenian-encoding-investigation.md)

Utility Agents (Session 20-21):
  - a0a3adf: Translation Gap Fixer — finding/fixing all gaps across DB (RUNNING)
  - a9fb74b: Armenian "Delays" Bug Fix — COMPLETE (all code + processed JSON fixed)
  - ab470fa: Featured Texts Reorganization — grouping by language, collapsible menus (COMPLETE)
  - aecb8ba: English Language Labels — ensure labels in English not native script (COMPLETE)
  - ab41354: Yerkir Nairi Paragraphing Fix — fixing epigraphs/structure (RUNNING)
  - a4fc5f0: Site Terminology Update — "pre-1900" → "pre-contemporary" (COMPLETE)
  - acf75d6: Armenian Encoding Investigation — documented "delays" issue (COMPLETE)
  - a85a667: Anna Saroyan Processor — 23 chapters processed, translation running (COMPLETE)

Armenian "Delays" Bug — RESOLVED:
  - Root cause: Armenian Unicode chars replaced with "delays" during text operations
  - Fix method: Python with Unicode codepoints to rebuild correct Armenian text
  - Files fixed: seed-db.ts, prompts.ts, 6 processing scripts, 60 JSON files regenerated
  - Verification: grep confirms no "delays" corruption in scripts or processed JSON
  - Report: docs/armenian-delays-fix-report.md
  - Prevention: always use Unicode escape sequences for Armenian text in code

Shisan Jing Zhushu (十三經註疏) — 13 texts, 455 chapters total:
  Status: 32/455 translated (~7%), ~20 parallel workers active
  Chapter ordering: VERIFIED CORRECT (all 13 texts, agent a430c04)
  Original agents (orchestration DONE, background workers running):
  - Agent 2 (ace30af): zhouyi (2 workers) + shangshu (1 worker)
  - Agent 3 (a86e80d): zhouli + yili + liji-zy + liji-zs (4 workers)
  - Agent 4 (ace6429): zuozhuan (3) + gongyang (2) + guliang (1) = 6 workers
  Reinforcement agents (additional coverage):
  - Agent A (a7e1ecc): yili-zhushu (2 workers) + erya-zhushu
  - Agent B (aca4e1f): zhouli-zhushu (2 workers) + xiaojing-zhushu
  - Agent C (a3bb94a): liji-zhengyi (2 workers) + liji-zhushu
  - Agent D (a541e9f): lunyu-zhushu + mengzi-zhushu + shangshu-zhengyi

To sync schema after code changes:
  set -a && source .env.local && set +a && pnpm db:push

To seed/re-seed:
  pnpm db:seed

================================================================================
## TRANSLATION API DETAILS
================================================================================

Provider: DeepSeek (OpenAI-compatible API)
Model: deepseek-chat (V3.2)
Base URL: https://api.deepseek.com
Max output: 8192 tokens
Cost: $0.28/M input, $0.42/M output

Batching strategy (language-aware):
- Classical Chinese (zh): MAX_CHARS_PER_BATCH = 1500 (very dense, 1 char ~ 3-5 English words)
- Greek (grc): MAX_CHARS_PER_BATCH = 6000 (moderate density)
- Latin (la): MAX_CHARS_PER_BATCH = 6000

Script: scripts/translate-batch.ts
Config: src/server/translation/client.ts (OpenAI SDK with DeepSeek baseURL)

### Gemini (for Tamil)
Provider: Google AI (Gemini API)
Model: gemini-2.5-flash
SDK: @google/genai v1.38.0
Max output: 8192 tokens (per call; model supports 65K)
Temperature: 0.3 (low for faithful translation)

Batching:
- Tamil (ta): MAX_CHARS_PER_BATCH = 4000 (moderate density Sangam verse)

Script: scripts/translate-tamil.ts
Config: src/server/translation/gemini-client.ts (GoogleGenAI singleton)
Prompts: src/server/translation/prompts.ts (LANGUAGE_INSTRUCTIONS['ta'])

Tamil Quality Pipeline (docs/tamil-translation-orchestration.md):
  Stage 1: Translation (Gemini 2.5 Flash, temp 0.3) — starts immediately
  Stage 2: Reviewer (starts when ≥20 poems translated, writes notes + retranslation requests)
  Stage 3: Master Retranslator (waits for both Stage 1+2 COMPLETE, prompt improvement + retranslation + editorial clarification pass)
  Shared coordination: docs/tamil-translation-notes/<text-slug>-pipeline-progress.md
  Notes directory: docs/tamil-translation-notes/
  IMPORTANT: Stage 3 includes MANDATORY editorial clarification (English terms + [transliteration] on first use)

Usage: pnpm tsx scripts/translate-tamil.ts --text <slug> [--start N] [--end N] [--delay MS]

IMPORTANT: Do NOT keep translation content in Claude Code context.
Write translations directly to the database via the translate scripts.

================================================================================
## DUAL-AGENT QUALITY PIPELINE (Formalized Workflow G)
================================================================================

Standard workflow for processing texts requiring quality verification.
Two agents collaborate via a shared document until both agree output is production-ready.

### Agents
| Role | Responsibility | Output |
|------|---------------|--------|
| Parser/Processor | Analyze source, extend configs, run parser, self-check | Raw .txt + processed .json |
| Reviewer/Critic | Independent quality review, grade, request fixes | Grade + sign-off |

### Lifecycle
1. Create joint collaboration doc: `docs/<pipeline>-collaboration.md`
2. Create scratchpads: `docs/<pipeline>-parser-scratchpad.md`, `docs/<pipeline>-reviewer-scratchpad.md`
3. Launch Parser Agent (processes texts, writes report to joint doc)
4. Launch Reviewer Agent (reviews output, writes grade to joint doc)
5. If NOT SATISFIED: Parser fixes → Reviewer re-reviews (iterate)
6. When SATISFIED: texts ready for seeding + translation
7. Post-approval: add to seed-db.ts, run pnpm db:seed, launch translation workers

### Sign-off Protocol
- Both agents sign entries: `[PARSER]`/`[PROCESSOR]` or `[REVIEWER]`/`[CRITIC]`
- Grade scale: A (perfect), A- (minor cosmetic), B+ (translatable), B (fixable), C+ (notable issues), C/below (reprocess)
- B+ or higher = suitable for translation
- Reviewer must explicitly state SATISFIED or NOT SATISFIED

### Prior Pipelines
| Pipeline | Texts | Grade | Joint Doc |
|----------|-------|-------|-----------|
| Carmina Graeca | 21 medieval Greek poems | A | docs/carmina-graeca-scratchpad.md |
| Eustathius (R1→R2) | 25 chapters (2 volumes) | B+ | docs/eustathius-r2-collaboration.md |
| Greek XML R1 | 3 texts (334 chapters) | A | docs/greek-xml-collaboration.md |
| Greek XML R2 | 4 texts (tlg3156+tlg4003) | IN PROGRESS | docs/greek-xml-r2-collaboration.md |

### Active Pipelines (Session 13)
- **Greek XML R2**: Parser (a46da65) + Reviewer (ae6bd83)
  - Texts: Hesiod Theogony Commentary + 3 Marcianus geographical works
  - Joint: docs/greek-xml-r2-collaboration.md
  - When complete: seed + translate

================================================================================
## KEY FILE LOCATIONS
================================================================================

### App pages
src/app/page.tsx                                    — Home page
src/app/(wiki)/texts/page.tsx                       — Browse all texts
src/app/(wiki)/[lang]/[author]/[text]/page.tsx      — Text index/TOC
src/app/(wiki)/[lang]/[author]/[text]/[chapter]/page.tsx — Chapter view
src/app/(wiki)/[lang]/[author]/[text]/[chapter]/edit/page.tsx — Edit page
src/app/(wiki)/[lang]/[author]/[text]/[chapter]/discussion/page.tsx — Discussion (planned)
src/app/(wiki)/admin/users/page.tsx                 — Admin user mgmt
src/app/(wiki)/search/page.tsx                      — Search page
src/app/(auth)/login/page.tsx                       — Login
src/app/(auth)/register/page.tsx                    — Register

### Components
src/components/interlinear/InterlinearViewer.tsx     — Two-column text display
src/components/interlinear/ParagraphPair.tsx         — Single paragraph row
src/components/editor/TextEditor.tsx                 — Translation editor
src/components/navigation/CategoryBrowser.tsx        — Language→Author→Text nav
src/components/navigation/TableOfContents.tsx        — Chapter list sidebar
src/components/endorsement/EndorseButton.tsx         — Endorsement toggle
src/components/history/                             — Version history/diff
src/components/home/FeaturedTexts.tsx               — Home page featured texts

### Server
src/server/db/schema.ts                             — Drizzle schema (all tables + textType)
src/server/db/index.ts                              — DB client
src/server/trpc/init.ts                             — tRPC setup + context
src/server/trpc/routers/texts.ts                    — Text listing queries
src/server/trpc/routers/translations.ts             — Translation CRUD
src/server/trpc/routers/users.ts                    — User management
src/server/trpc/routers/discussions.ts              — Discussion threads (planned)
src/server/auth/index.ts                            — NextAuth config
src/server/translation/client.ts                    — DeepSeek API client
src/server/translation/gemini-client.ts             — Gemini API client (Tamil)
src/server/translation/prompts.ts                   — Language-specific translation prompts

### Scripts
scripts/seed-db.ts                                  — Seed DB from processed data
scripts/translate-batch.ts                          — AI translation (DeepSeek, zh/grc/la)
scripts/translate-tamil.ts                          — AI translation (Gemini, Tamil)
scripts/acquire-ctext.ts                            — Fetch from ctext.org
scripts/acquire-archive.ts                          — Fetch from Internet Archive
scripts/process-texts.ts                            — Clean raw → processed
scripts/process-chuanxilu.ts                        — Process Chuanxilu text
scripts/process-huangdi.ts                          — Process Huang Di Nei Jing
scripts/process-new-texts.ts                        — Process De Anima, Lombards, Regno, Tongjian
scripts/process-carmina-graeca.ts                   — Process Carmina Graeca (21 medieval Greek poems)
scripts/process-yashodhara-kaviyam.ts               — Process Yashodhara Kaviyam (5 carukkams, 330 verses)
scripts/process-udayanakumara-kaviyam.ts            — Process Udayanakumara Kaviyam (6 kandams, 366 verses)
scripts/process-eustathius.ts                       — Process Eustathius Odyssey Commentary (being built by agent)
scripts/process-greek-xml.ts                        — Process TEI-XML Greek texts (being built by agent)
scripts/lib/carmina/                                — Carmina processing modules (6 files, REFERENCE IMPL)
scripts/lib/eustathius/                             — Eustathius processing modules (being built by agent)
scripts/lib/greek-xml/                              — TEI-XML parser modules (being built by agent)
scripts/fix-chapter-titles.ts                       — Add English to chapter titles
scripts/fill-translation-gaps.ts                    — Retranslate empty paragraphs in existing translations
scripts/_check-translation-gaps.ts                  — Diagnostic: find chapters with empty paragraphs
scripts/_check-empty-source.ts                      — Diagnostic: verify gaps are genuine (not empty source)
scripts/sangam/                                     — Tamil corpus processing scripts (Sangam agent)

### Data
data/processed/zhuziyulei/chapter-NNN.json          — ZZYL source (140 files)
data/processed/ceremonialis/chapter-NNN.json        — Ceremonialis source (7 files)
data/processed/chuanxilu/chapter-N.json             — Chuanxilu source (3 files)
data/processed/huangdineijing/chapter-NNN.json      — HDNJ source (55 files)
data/processed/deanima/chapter-NNN.json             — De Anima source (18 files)
data/processed/elegia/chapter-NNN.json              — Elegia source (4 files)
data/processed/lombards/chapter-NNN.json            — Lombards source (82 files)
data/processed/regno/chapter-NNN.json               — Regno source (56 files)
data/processed/tongjian/chapter-NNN.json            — Tongjian source (45 files)
data/processed/ptochoprodromos/chapter-NNN.json     — Ptochoprodromos source (2 files)
data/processed/carmina-graeca/chapter-NNN.json      — Carmina Graeca source (21 files)
data/greek_xml/                                     — TEI-XML Greek source files (3 files, First1KGreek corpus)
data/difficult_extra_processing/                    — Difficult OCR files needing agent-based processing
data/raw/                                           — (gitignored) raw downloads
data/raw/carmina-graeca/                            — 21 clean Greek .txt files (10,957 lines, Grade A quality)
data/raw/eustathius-odyssey/                        — Eustathius commentary chapters (being built by agent)
data/raw/sangam/                                    — Cleaned Sangam Tamil texts (Ettuthokai + Pattuppattu)
data/raw/sangam/ettuthokai/akananuru/               — 400/400 poems extracted (COMPLETE)
data/raw/sangam/ettuthokai/purananuru/              — 128/400 poems (rest absent from corpus)
data/raw/sangam/pattuppattu/porunararruppadai/      — 248 lines (COMPLETE)
data/raw/nandikkalambakam/                          — Original + cleaned (114 poems, 641 verse lines)
data/raw/culamani/                                  — Parts 1+3 clean, Part 2 CORRUPTED (needs re-sourcing)
data/raw/yashodhara-kaviyam/                        — COMPLETE (all 5 carukkams, 330 verses)
data/raw/udayanakumara-kaviyam/                     — 367 verses in 6 kandams (related to Perunkathai)
docs/sangam-inspector.md                            — Full corpus inspection report
docs/sangam-scratchpad.md                           — Sangam agent working notes (TBD)
docs/sangam-reference.md                            — Sangam corpus reference/catalog (TBD)
docs/tamil-translation-orchestration.md             — Tamil 3-stage pipeline design doc
docs/tamil-translation-notes/                       — Tamil pipeline progress + reviewer notes (per text)
docs/plan-carmina-graeca-processing.md              — Carmina Graeca pipeline plan + results (REFERENCE)
docs/carmina-graeca-scratchpad.md                   — Carmina Graeca working notes (REFERENCE)
docs/carmina-graeca-critiques.md                    — Carmina Graeca quality evaluations (REFERENCE)
docs/plan-eustathius-processing.md                  — Eustathius pipeline plan (written by agent)
docs/eustathius-scratchpad.md                       — Eustathius working notes (written by agent)
docs/eustathius-odyssey-agent-instructions.md       — Eustathius coordination (both volumes)
docs/plan-greek-xml-processing.md                   — Greek XML parser plan (written by agent)
docs/greek-xml-scratchpad.md                        — Greek XML working notes (written by agent)

### Config
drizzle.config.ts                                   — Drizzle ORM config
next.config.ts                                      — Next.js config
tailwind.config.ts                                  — Tailwind config
vitest.config.mts                                   — Test config
.env.local                                          — Local env (gitignored)
.env.example                                        — Env template (committed)

### Reference files (for Claude Code sessions)
CLAUDE.md                                           — Project architecture & conventions
scratch-notes.txt                                   — Session-by-session working notes
reference-guide.txt                                 — THIS FILE: structured quick reference
communications-to-the-User.txt                      — Implementation plan & deployment guide

================================================================================
## IMPLEMENTATION STATUS BY PHASE
================================================================================

Phase 1 (Scaffolding):        COMPLETE
Phase 2 (Text Acquisition):   COMPLETE (20 texts, 600+ chapters total)
Phase 3 (Reading UI):          COMPLETE (prose + poetry display modes)
Phase 4 (Editing/Versioning): COMPLETE
Phase 5 (Endorsements):       COMPLETE
Phase 6 (AI Translation):     NEAR COMPLETE (580+ chapters translated; Tongjian + Nandikkalambakam in progress)
Phase 7 (Search/Polish):      PARTIAL (search page exists, SEO metadata added)
Phase 8 (Deployment):         COMPLETE (live at deltoi.com)

Additional features:
- Poetry display mode (line numbers every 5th line, compact spacing)
- Discussion pages (fully implemented: threads, replies, resolve, pin)
- Mobile source toggle (hide original text button, mobile-only, agent a517451)

================================================================================
## PROCESSING WORKFLOWS & DOCUMENTATION MAP
================================================================================

### Workflow A: Adding a New Text (Standard)
1. Place raw text in `data/raw/<dirname>/`
2. Write processing script: `scripts/process-<name>.ts`
   - Output: `data/processed/<slug>/chapter-NNN.json`
   - Format: `{ chapterNumber, title, sourceContent: { paragraphs: [{ index, text }] } }`
3. Add author + text entries to `scripts/seed-db.ts`
   - Title format: "English Name (Transliteration)" — MANDATORY
4. Run `pnpm tsx scripts/seed-db.ts`
5. Translate: `pnpm tsx scripts/translate-batch.ts --text <slug>` (DeepSeek, for zh/grc/la)
   OR: `pnpm tsx scripts/translate-tamil.ts --text <slug>` (Gemini, for ta)

### Workflow B: OCR Text Processing (Difficult Extra Processing)
Used for: Internet Archive djvu scans, corrupted/noisy OCR files
Reference implementation: Carmina Graeca pipeline (scripts/lib/carmina/, 6 modules)
Current instance: Eustathius Odyssey Commentary (scripts/lib/eustathius/)

Pattern:
1. Source file in `data/difficult_extra_processing/`
2. Create multi-module pipeline in `scripts/lib/<name>/`:
   - types.ts, splitter.ts, cleaner.ts, normalizer.ts, validator.ts, index.ts
3. Create main script: `scripts/process-<name>.ts`
4. Agent writes documentation: `docs/plan-<name>-processing.md`, `docs/<name>-scratchpad.md`
5. Quality checks: PASS/WARN/FAIL per chapter, overall grade

Dual-Agent Quality Pattern (Processor + Reviewer):
- Processing Agent: produces clean text from OCR
- Reviewer Agent: evaluates output, writes critiques, grades (A/B/C/D/F)
- Shared collaboration doc: `docs/<name>-collaboration.md` (both read/write)
- Each agent has its own scratchpad for working notes
- Iterate: Processor fixes issues raised by Reviewer, Reviewer re-evaluates
- Goal: Grade A (production-ready, clean, complete, accurate)
- Reviewer signs entries `[REVIEWER]`, Processor signs `[PROCESSOR]`

Key documents:
- `docs/plan-carmina-graeca-processing.md` — Processing plan + results (reference)
- `docs/carmina-graeca-scratchpad.md` — Working notes (read for methodology)
- `docs/carmina-graeca-critiques.md` — Quality evaluations (FORMAT REFERENCE)
- `docs/eustathius-odyssey-agent-instructions.md` — Eustathius coordination (both volumes)
- `docs/eustathius-collaboration.md` — Shared doc for Processor + Reviewer interaction
- `docs/plan-eustathius-processing.md` — Eustathius plan + results (Processor writes)
- `docs/eustathius-scratchpad.md` — Eustathius Processor working notes
- `docs/eustathius-reviewer-scratchpad.md` — Eustathius Reviewer working notes

Critical rule for Greek OCR: Medieval/Ancient Greek NEVER contains Arabic numerals.
Any digit in the text = page number / apparatus / line reference → STRIP IT.

### Workflow C: TEI-XML Processing (First1KGreek / Perseus)
Used for: Structured XML files from the First1KGreek or Perseus Digital Library corpus
Current instance: Greek XML parser agent (scripts/lib/greek-xml/)

Pattern:
1. Source XML files in `data/greek_xml/` (TEI-XML, EpiDoc schema)
2. Reusable parser in `scripts/lib/greek-xml/`:
   - types.ts, tei-parser.ts, text-extractor.ts, chapter-splitter.ts, validator.ts
3. Main script: `scripts/process-greek-xml.ts` (handles any TLG file)
4. Agent documentation: `docs/plan-greek-xml-processing.md`, `docs/greek-xml-scratchpad.md`

TEI-XML key elements:
- `<div type="edition">` — main text body
- `<div type="textpart" subtype="book|chapter|section">` — structural divisions
- `<pb n="123"/>` — page breaks (strip)
- `<lb n="5"/>` — line breaks (milestone, strip)
- `<note>` — footnotes/apparatus (strip)
- Namespace: `http://www.tei-c.org/ns/1.0`

### Workflow D: Tamil 3-Stage Quality Pipeline
Used for: All Tamil (ta) texts requiring quality-assured translations
Reference: `docs/tamil-translation-orchestration.md`
Notes directory: `docs/tamil-translation-notes/`

Stages:
1. **Stage 1 — Translation**: Agent processes raw text, seeds DB, translates via Gemini 2.5 Flash
   - Script: `scripts/translate-tamil.ts`
   - Output: TranslationVersion v1 in DB
   - Coordination file: `docs/tamil-translation-notes/<slug>-pipeline-progress.md`

2. **Stage 2 — Reviewer**: Independent agent reads translations, compares to source
   - Output: `<slug>-reviewer-notes.md` (overall grade + per-chapter assessment)
   - Output: `<slug>-retranslation-requests.md` (specific verses + priority)
   - Grade scale: A/B/C/D/F with +/- modifiers
   - Per-verse: PROBLEMATIC / ADEQUATE / GOOD

3. **Stage 3 — Master Retranslator**: Reads reviewer notes, improves prompt, retranslates
   - Creates TranslationVersion v2 (retranslation) + v3 (editorial clarification)
   - Editorial clarification: English terms with [transliteration] on first use only
   - Must address any prompt mismatch issues (e.g., Sangam prompt on medieval text)

Pipeline progress files (one per text):
- `docs/tamil-translation-notes/nandikkalambakam-pipeline-progress.md`
- `docs/tamil-translation-notes/yashodhara-kaviyam-pipeline-progress.md`
- `docs/tamil-translation-notes/udayanakumara-kaviyam-pipeline-progress.md`

### Workflow E: Documentation Maintenance (MANDATORY)
Every session and every agent MUST maintain these files:

| File | What to record | When to update |
|------|---------------|----------------|
| `scratch-notes.txt` | Session progress, decisions, agent launches/completions, issues | Continuously during work |
| `reference-guide.txt` | Project state, new texts, translation coverage, file locations | When state changes |
| `CLAUDE.md` | Active tasks, architecture changes, conventions, remaining work | When tasks change |

Rules:
- Start every session by reading all three files
- Update scratch-notes as you work (don't wait until end)
- Update reference-guide when a text is seeded, translation completes, or agent finishes
- Update CLAUDE.md Active Tasks when agents launch/complete
- Agents that write their own docs (scratchpads, plans) should be noted in CLAUDE.md
- NEVER leave stale information in these files — always reflect current truth

### Workflow F: Translation Workers (Batch Background)
Used for: Large texts that need many chapters translated (zh/grc/la via DeepSeek)

Pattern:
1. Split chapter ranges across multiple background `pnpm tsx scripts/translate-batch.ts` processes
2. Each worker runs with `--text <slug> --start N --end M --delay 5000`
3. Workers skip already-translated chapters automatically
4. Error handling: `translateBatchWithRetry()` — 3 retries + batch splitting on failure
5. Monitor via background bash task output files

### Workflow H: Chinese Commentary Text Processing (十三經註疏 Pattern)
Used for: Multi-layered Classical Chinese commentary editions (base text + 註 + 疏)
Current instance: Shisan Jing Zhushu (13 texts, 455 chapters)

Pattern:
1. Source .txt files in `data/raw/<corpus>/` — one file per volume (卷)
2. Index file provides correct chapter ordering
3. Processing script: `scripts/process-shisan-jing-{1,2,3,4}.ts`
   - Strips header lines (e.g., "原文(無註)")
   - Preserves ALL commentary layers (they ARE the text in a 註疏 edition)
   - Splits on [疏] boundaries and natural textual breaks
   - Output: `data/processed/<slug>/chapter-NNN.json`
4. Author + text entries added to `scripts/seed-db.ts`
5. Seed: `pnpm tsx scripts/seed-db.ts`
6. Translate: Multiple parallel workers with `--delay 2000`

Commentary format elements:
- Base text: 子曰：「...」 (Confucius said: "...")
- Zheng Xuan/He Yan gloss: （parenthetical notes）
- Sub-commentary: [疏] or [疏正義曰：...]
- Scholar attributions: 【鄭玄】, ○ markers
- Section headers: 卷一·學而第一

Key rules:
- ALL layers preserved in source_content paragraphs
- Volume numbers = chapter ordering (卷一 < 卷二 < ...)
- Index cross-references (bare book names without /) are NOT chapters — skip them
- Chinese numerals and Arabic numerals both used in filenames

================================================================================
## REMAINING WORK (PRIORITY ORDER)
================================================================================

1. Wait for Shisan Jing Zhushu translation (13 texts, 455 ch, ~200/455 done, 128 workers)
2. Wait for Eustathius translation workers (31/37 done, 16 workers)
3. Add English translations to Chinese-only chapter titles (script needed, ~500 chapters)
4. Update AUTH_URL on Vercel to https://deltoi.com
5. Sangam Tamil: 15 more canonical works need sourcing from Project Madurai
6. Responsive design polish (mobile stacking for interlinear viewer)
7. Error boundaries and loading skeletons
8. Migrate "middleware" to "proxy" convention (Next.js 16 deprecation)
9. Upgrade NextAuth from beta to stable when available
10. Add Ling Shu (靈樞) chapters to HDNJ when user provides raw data

ACTIVE AGENTS (Session 19 — 2026-01-24):
Background translation workers:
  - rizhilu: 4 workers (0/32) — agent a400ec2
  - eustathius-odyssey: 16 workers (~31/37)
  - Shisan Jing Zhushu: ~128 workers across 13 texts (ongoing)
Mobile toggle feature: COMPLETE (agent a517451)

COMPLETED RECENTLY (Sessions 13-19):
✓ Kongzi Jiayu: 80/80 COMPLETE
✓ Hesiod Exegesis: Regrouped 109→13, 13/13 COMPLETE
✓ Tongjian: 45/45 COMPLETE
✓ Historia Nova: 332/332 COMPLETE
✓ Sophistici Elenchi: 35/35 COMPLETE
✓ Diognetum: 12/12 COMPLETE
✓ Greek XML R2: 53/53 COMPLETE (all 4 texts)
✓ Carmina Graeca: 21/21 COMPLETE
✓ Naming consistency: all titles "English Name (Transliteration)"
✓ Guliang Zhuan: 20/20 COMPLETE
✓ Yi Li: 17/17 COMPLETE
✓ Baihu Tong: 56/56 COMPLETE
✓ Chapter ordering verification: all 13 Shisan Jing texts CORRECT
✓ Fengsu Tongyi: 11/11 COMPLETE
✓ Gaoshi Zhuan: 4/4 COMPLETE
✓ Yi Zhou Shu: 62/62 COMPLETE with commentary brackets
✓ Nandikkalambakam: 114/114 COMPLETE (all 3 stages)
✓ Xiaojing Zhushu: 17/17 COMPLETE
✓ Lunyu Zhushu: 21/27 (nearly complete, workers active)
✓ Zhouyi Zhengyi: 52/100 (halfway, workers active)
✓ Search language filter: Added toggleable badge filters (Session 18)
✓ Chapter title parsing: parseChapterTitle() applied across all pages (Session 18)
✓ Homepage: "Search Texts" button replaces "Register to Contribute" (Session 18)
✓ Erya Zhushu ch1 + Zhouyi Zhengyi 4ch: Scraping artifacts removed (Session 18)
✓ Diarium Urbis Romae: 66/66 COMPLETE (Session 19, paragraph fix v2)
✓ Mobile source toggle: FAB to hide original text on mobile (Session 19, agent a517451)
✓ Rizhilu pipeline: Processing + seeding COMPLETE, translation in progress (Session 19)

================================================================================
## CONVENTIONS & RULES
================================================================================

1. Schema changes: edit src/server/db/schema.ts, then run `pnpm db:push`
2. Never use migrations in dev — use db:push (schema is already in production via push)
3. Translations are append-only versions — never mutate TranslationVersion rows
4. Paragraph indices must match between source and translation
5. Source texts are immutable after seeding
6. URLs are human-readable slugs: /[lang]/[author]/[text]/[chapter]
7. Chinese text uses Noto Serif CJK font; Greek uses polytonic-capable serif
8. All text content is UTF-8 NFC normalized
9. DeepSeek (not Anthropic/Claude) is the translation API — uses OpenAI SDK
10. Keep scratch-notes.txt and reference-guide.txt updated every session
11. Title naming convention: "English Name (Transliteration)" for ALL languages
    - e.g., "Classified Conversations of Master Zhu (Zhu Zi Yu Lei)"
    - e.g., "The War-Bard's Guide (Porunararruppadai)"
    - Texts with already-English original titles (Latin/Greek) stay as-is: "On the Soul"
12. Documentation maintenance is MANDATORY — not optional. Every session MUST:
    - Read all 3 reference files (CLAUDE.md, reference-guide.txt, scratch-notes.txt) at start
    - Update scratch-notes.txt continuously (progress, decisions, agent launches/completions)
    - Update reference-guide.txt when project state changes
    - Update CLAUDE.md Active Tasks when agents launch or complete
    - Mark completed items as COMPLETE in ALL files (no stale info)
13. Subagents that do complex processing MUST write their own documentation:
    - Plan file: `docs/plan-<name>-processing.md` (analysis, decisions, results)
    - Scratchpad: `docs/<name>-scratchpad.md` (working notes, observations)
    - These docs enable future sessions/agents to understand methodology
14. OCR Greek text rule: Ancient/Medieval Greek NEVER contains Arabic numerals.
    Any embedded digit = page number / apparatus / line reference → MUST be stripped.
15. Tamil texts always go through the 3-stage pipeline (see Workflow D above).
    Never deploy Tamil translations without reviewer + retranslation pass.
16. Neon PostgreSQL project ID: `bitter-tooth-04461121` — use for all DB queries
17. Database column names are snake_case in SQL (e.g., `source_content`, `text_id`)
    even though Drizzle schema uses camelCase in TypeScript

================================================================================
## COMMON COMMANDS
================================================================================

# Development
pnpm dev                          # Start dev server (localhost:3000)
pnpm build                        # Production build (also used by Vercel)
pnpm lint                         # ESLint
pnpm typecheck                    # tsc --noEmit

# Database
set -a && source .env.local && set +a   # Load env vars for CLI tools
pnpm db:push                      # Sync schema to Neon
pnpm db:seed                      # Seed texts into DB
pnpm db:studio                    # Drizzle Studio GUI

# Translation
pnpm translate:batch              # Run AI translations (needs DEEPSEEK_API_KEY)

# Git & Deploy
git push origin main              # Triggers Vercel auto-deploy
gh api repos/translorentz/translation-wiki/deployments --jq '.[0]'  # Check deploy

================================================================================
## KNOWN ISSUES
================================================================================

- Next.js 16 "middleware" deprecation warning (non-blocking, still works)
- NextAuth v5 beta (5.0.0-beta.30) — no stable release yet
- AUTH_URL on Vercel may still reference translation-wiki.vercel.app
- Translation workers in progress — ~100+ chapters still being translated
- Discussion pages implemented but not yet tested end-to-end in production
- HDNJ currently only has Su Wen (55 ch); Ling Shu (81 ch) to be added later

================================================================================
## SANGAM TAMIL CORPUS NOTES
================================================================================

Source: data/difficult_extra_processing/tamil_corpus/ (1,768,068 lines, 1000+ files)
Origin: Project Madurai (Tamil Virtual Academy) e-texts
Purpose: Organise and clean for future inclusion in the wiki (NOT for translation yet)

### Source File Format (Project Madurai pattern)
- Lines 1-20: Project info header (title, encoding, credits, copyright notice)
- Content: Tamil verse/prose text with embedded line markers
- End: Footer (colophon, "This page was last updated on..." line)
- Numbers: Standalone integers = poem numbers OR line counts OR in-poem markers (every 5th line)
- Corruptions: Some numbers have spaces inside ("1 5" = 15), OCR artifacts

### Ettuthokai Source Files Found
| Anthology | Corpus File | Status |
|-----------|------------|--------|
| Akananuru | 229_அகநானுறு - மூலம்.txt | 395/400 poems extracted |
| Puranānuru | (TBD — agent searching) | Script written |
| Narrinai | (TBD) | Not yet found |
| Kuruntokai | (TBD) | Not yet found |
| Ainkurunuru | (TBD) | Not yet found |
| Patirruppattu | (TBD) | Not yet found |
| Paripadal | (TBD) | Not yet found |
| Kalittokai | (TBD) | Not yet found |

### Pattuppattu Source Files Found
| Poem | Corpus File | Status |
|------|------------|--------|
| Porunararruppadai | (found) | Extracted |
| Others (9) | (TBD) | Directories created |

### Known Cleaning Challenges
1. Corrupted numbers (spaces inside: "1 5" = 15) — 3 instances in Akananuru
2. End-of-text boundary (last 2 poems merged, colophon/footer leaked)
3. Apparatus markers (.NNN-NN) embedded in verse lines
4. Line markers (multiples of 5) vs poem numbers — disambiguated by context
5. Section headers (numbered Tamil titles) — must be separated from verse
6. Multi-part files: some works split across 2-3 files (பாகம் 1, 2, 3)

### Scripts
| Script | Purpose |
|--------|---------|
| scripts/sangam/clean-akananuru.ts | Tokenizer-based parser, 3-section aware |
| scripts/sangam/clean-puranānuru.ts | Puranānuru processing |
| scripts/sangam/clean-porunar.ts | Porunararruppadai processing |
| scripts/sangam/clean-nandikkalambakam.ts | Strips meter labels, extracts pure verse (114 poems) |

### Output Structure
data/raw/sangam/
├── ettuthokai/
│   ├── akananuru/ (invocation.txt + poem-NNN.txt, 1-400)
│   ├── puranānuru/ (TBD)
│   └── ... (6 more anthologies)
└── pattuppattu/
    ├── porunararruppadai/poem.txt
    ├── tirumurukarruppadai/
    ├── cirupanarruppadai/
    ├── perumpanarruppadai/
    ├── mullaippattu/
    ├── maturaikkanci/
    ├── netunalvatai/
    ├── kurincippattu/
    ├── pattinappalai/
    └── malaipatakatam/

================================================================================
## TRANSLATION PARALLELIZATION NOTES
================================================================================

For large texts (ZZYL 140ch, HDNJ 55ch), split into parallel workers:
  pnpm translate:batch -- --text zhuziyulei --start 58 --end 78 --delay 4000

Key flags:
- --start N / --end N: chapter range
- --delay N: milliseconds between chapters (4000ms per worker when 4+ workers)
- Script auto-skips chapters with existing translations (checks currentVersionId)

Rate limit strategy:
- 1-2 workers: --delay 2000
- 3-4 workers: --delay 4000
- 5+ workers: --delay 5000+

Never pipe translation output through `head` or other truncating commands (SIGPIPE kills process).
