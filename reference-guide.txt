# Translation Wiki — Reference Guide for Claude Code Sessions
#
# This file provides structured, up-to-date reference information for
# Claude Code sessions and subagents. Always read this file at the start
# of a session to understand the current state of the project.
#
# Last updated: 2026-01-24 (Session 11)

================================================================================
## PROJECT IDENTITY
================================================================================

Name: Deltoi
Domain: https://deltoi.com
GitHub: https://github.com/translorentz/translation-wiki.git
Branch: main (single-branch workflow, auto-deploys to Vercel on push)

================================================================================
## CURRENT DEPLOYMENT STATUS
================================================================================

Platform: Vercel (auto-deploys from GitHub main branch)
Database: Neon PostgreSQL (free tier)
Domain: deltoi.com (custom domain on Vercel)
Latest deploy: 2026-01-23, commit 4c0f9d8 (split author/era in Featured Texts)

Environment variables (set in Vercel dashboard):
- DATABASE_URL — Neon connection string
- AUTH_SECRET — random base64 secret
- AUTH_URL — should be https://deltoi.com (NOTE: was translation-wiki.vercel.app, needs update)
- DEEPSEEK_API_KEY — for server-side translation features

Known issue: AUTH_URL env var on Vercel may still be set to
translation-wiki.vercel.app instead of https://deltoi.com. User should
update this in Vercel dashboard → Settings → Environment Variables.

================================================================================
## TECH STACK (ACTUAL, NOT PLANNED)
================================================================================

- Next.js 16.1.4 (App Router, Turbopack)
- TypeScript
- React 19
- Tailwind CSS
- Shadcn UI components
- tRPC v11 (fetchRequestHandler, createCaller for RSC)
- Drizzle ORM (postgres.js driver)
- NextAuth.js v5 beta (JWT strategy, credentials provider)
- PostgreSQL (Neon, cloud)
- DeepSeek V3.2 API (deepseek-chat) for AI translations (zh, grc, la)
- Google Gemini 2.5 Flash (@google/genai SDK) for Tamil translations
- Vitest + @testing-library/react (testing)

================================================================================
## DATABASE STATE
================================================================================

Schema synced via: `pnpm db:push` (drizzle-kit push, NOT migrations)

Tables:
- users, languages, authors, texts, chapters
- translations, translation_versions, endorsements

Current data:
- 5 languages: zh (Classical Chinese), grc (Koine Greek), la (Latin), en (English), ta (Tamil)
- 19 authors seeded: Zhu Xi, Constantine VII, Wang Yangming, Cassiodorus,
  Henry of Settimello, Erchempert, Hugo Falcandus, Yuan Shu, Huangdi (trad.),
  Theodore Prodromos, Wilhelm Wagner, Guliang Chi, Mudathirumaran, Ban Gu,
  Zheng Xuan, Zhou Court Scribes, Ying Shao, Huangfu Mi, Nandikkalambakam Poets
- 20 texts seeded (naming convention: "English Name (Transliteration)"):
  - Classified Conversations of Master Zhu (Zhu Zi Yu Lei) — 140 chapters, zh
  - On the Ceremonies of the Byzantine Court — 7 chapters, grc
  - Instructions for Practical Living (Chuan Xi Lu) — 3 chapters, zh
  - On the Soul — 18 chapters, la
  - Elegy on Misfortune — 4 chapters, la (textType=poetry)
  - History of the Lombards of Benevento — 82 chapters, la
  - The Book of the Kingdom of Sicily — 56 chapters, la
  - Narratives from the Comprehensive Mirror (Tongjian Jishi Benmo) — 45 chapters, zh
  - Poems of Poor Prodromos (Ptochoprodromika) — 2 chapters, grc (textType=poetry)
  - The Yellow Emperor's Classic of Medicine (Huang Di Nei Jing) — 55 chapters, zh
  - Medieval Greek Poems (Carmina Graeca Medii Aevi) — 21 chapters, grc (textType=poetry)
  - Commentary of Guliang (Guliang Zhuan) — 12 chapters, zh
  - The War-Bard's Guide (Porunararruppadai) — 1 chapter, ta (textType=poetry)
  - Comprehensive Discussions in the White Tiger Hall (Baihu Tong) — 43 chapters, zh
  - Biographies of Lofty Scholars (Gaoshi Zhuan) — 4 chapters, zh
  - Ceremonies and Rites (Yi Li) — 17 chapters, zh
  - Lost Book of Zhou (Yi Zhou Shu) — 62 chapters, zh (commentary in [brackets])
  - Comprehensive Meaning of Customs (Fengsu Tongyi) — 11 chapters, zh
  - The Anthology of Nandi (Nandikkalambakam) — 114 chapters, ta (textType=poetry)

Translation coverage (Session 11 — updated 2026-01-24):
- ZZYL: 140/140 COMPLETE
- Ceremonialis: 7/7 COMPLETE
- Chuanxilu: 3/3 COMPLETE
- De Anima: 18/18 COMPLETE
- Elegia: 4/4 COMPLETE
- Lombards: 82/82 COMPLETE
- Regno: 56/56 COMPLETE
- Tongjian: IN PROGRESS (workers b83ad01, b76003b still running)
- Ptochoprodromos: 2/2 COMPLETE
- HDNJ: 55/55 COMPLETE
- Carmina Graeca: 21/21 COMPLETE
- Guliang Zhuan: 12/12 COMPLETE
- The War-Bard's Guide (Porunararruppadai): 1/1 COMPLETE (v3: editorial clarification)
- Baihu Tong: 43/43 COMPLETE
- Gaoshi Zhuan: 4/4 COMPLETE
- Yi Li: 17/17 COMPLETE
- Yi Zhou Shu: 62/62 COMPLETE (commentary in [brackets] preserved)
- Fengsu Tongyi: 11/11 COMPLETE
- Nandikkalambakam: IN PROGRESS (Stage 1: 109/114; Stage 2 Reviewer DONE; Stage 3 pending)

To sync schema after code changes:
  set -a && source .env.local && set +a && pnpm db:push

To seed/re-seed:
  pnpm db:seed

================================================================================
## TRANSLATION API DETAILS
================================================================================

Provider: DeepSeek (OpenAI-compatible API)
Model: deepseek-chat (V3.2)
Base URL: https://api.deepseek.com
Max output: 8192 tokens
Cost: $0.28/M input, $0.42/M output

Batching strategy (language-aware):
- Classical Chinese (zh): MAX_CHARS_PER_BATCH = 1500 (very dense, 1 char ~ 3-5 English words)
- Greek (grc): MAX_CHARS_PER_BATCH = 6000 (moderate density)
- Latin (la): MAX_CHARS_PER_BATCH = 6000

Script: scripts/translate-batch.ts
Config: src/server/translation/client.ts (OpenAI SDK with DeepSeek baseURL)

### Gemini (for Tamil)
Provider: Google AI (Gemini API)
Model: gemini-2.5-flash
SDK: @google/genai v1.38.0
Max output: 8192 tokens (per call; model supports 65K)
Temperature: 0.3 (low for faithful translation)

Batching:
- Tamil (ta): MAX_CHARS_PER_BATCH = 4000 (moderate density Sangam verse)

Script: scripts/translate-tamil.ts
Config: src/server/translation/gemini-client.ts (GoogleGenAI singleton)
Prompts: src/server/translation/prompts.ts (LANGUAGE_INSTRUCTIONS['ta'])

Tamil Quality Pipeline (docs/tamil-translation-orchestration.md):
  Stage 1: Translation (Gemini 2.5 Flash, temp 0.3) — starts immediately
  Stage 2: Reviewer (starts when ≥20 poems translated, writes notes + retranslation requests)
  Stage 3: Master Retranslator (waits for both Stage 1+2 COMPLETE, prompt improvement + retranslation + editorial clarification pass)
  Shared coordination: docs/tamil-translation-notes/<text-slug>-pipeline-progress.md
  Notes directory: docs/tamil-translation-notes/
  IMPORTANT: Stage 3 includes MANDATORY editorial clarification (English terms + [transliteration] on first use)

Usage: pnpm tsx scripts/translate-tamil.ts --text <slug> [--start N] [--end N] [--delay MS]

IMPORTANT: Do NOT keep translation content in Claude Code context.
Write translations directly to the database via the translate scripts.

================================================================================
## KEY FILE LOCATIONS
================================================================================

### App pages
src/app/page.tsx                                    — Home page
src/app/(wiki)/texts/page.tsx                       — Browse all texts
src/app/(wiki)/[lang]/[author]/[text]/page.tsx      — Text index/TOC
src/app/(wiki)/[lang]/[author]/[text]/[chapter]/page.tsx — Chapter view
src/app/(wiki)/[lang]/[author]/[text]/[chapter]/edit/page.tsx — Edit page
src/app/(wiki)/[lang]/[author]/[text]/[chapter]/discussion/page.tsx — Discussion (planned)
src/app/(wiki)/admin/users/page.tsx                 — Admin user mgmt
src/app/(wiki)/search/page.tsx                      — Search page
src/app/(auth)/login/page.tsx                       — Login
src/app/(auth)/register/page.tsx                    — Register

### Components
src/components/interlinear/InterlinearViewer.tsx     — Two-column text display
src/components/interlinear/ParagraphPair.tsx         — Single paragraph row
src/components/editor/TextEditor.tsx                 — Translation editor
src/components/navigation/CategoryBrowser.tsx        — Language→Author→Text nav
src/components/navigation/TableOfContents.tsx        — Chapter list sidebar
src/components/endorsement/EndorseButton.tsx         — Endorsement toggle
src/components/history/                             — Version history/diff
src/components/home/FeaturedTexts.tsx               — Home page featured texts

### Server
src/server/db/schema.ts                             — Drizzle schema (all tables + textType)
src/server/db/index.ts                              — DB client
src/server/trpc/init.ts                             — tRPC setup + context
src/server/trpc/routers/texts.ts                    — Text listing queries
src/server/trpc/routers/translations.ts             — Translation CRUD
src/server/trpc/routers/users.ts                    — User management
src/server/trpc/routers/discussions.ts              — Discussion threads (planned)
src/server/auth/index.ts                            — NextAuth config
src/server/translation/client.ts                    — DeepSeek API client
src/server/translation/gemini-client.ts             — Gemini API client (Tamil)
src/server/translation/prompts.ts                   — Language-specific translation prompts

### Scripts
scripts/seed-db.ts                                  — Seed DB from processed data
scripts/translate-batch.ts                          — AI translation (DeepSeek, zh/grc/la)
scripts/translate-tamil.ts                          — AI translation (Gemini, Tamil)
scripts/acquire-ctext.ts                            — Fetch from ctext.org
scripts/acquire-archive.ts                          — Fetch from Internet Archive
scripts/process-texts.ts                            — Clean raw → processed
scripts/process-chuanxilu.ts                        — Process Chuanxilu text
scripts/process-huangdi.ts                          — Process Huang Di Nei Jing
scripts/process-new-texts.ts                        — Process De Anima, Lombards, Regno, Tongjian
scripts/process-carmina-graeca.ts                   — Process Carmina Graeca (21 medieval Greek poems)
scripts/lib/carmina/                                — Carmina processing modules (6 files)
scripts/fix-chapter-titles.ts                       — Add English to chapter titles
scripts/fill-translation-gaps.ts                    — Retranslate empty paragraphs in existing translations
scripts/_check-translation-gaps.ts                  — Diagnostic: find chapters with empty paragraphs
scripts/_check-empty-source.ts                      — Diagnostic: verify gaps are genuine (not empty source)
scripts/sangam/                                     — Tamil corpus processing scripts (Sangam agent)

### Data
data/processed/zhuziyulei/chapter-NNN.json          — ZZYL source (140 files)
data/processed/ceremonialis/chapter-NNN.json        — Ceremonialis source (7 files)
data/processed/chuanxilu/chapter-N.json             — Chuanxilu source (3 files)
data/processed/huangdineijing/chapter-NNN.json      — HDNJ source (55 files)
data/processed/deanima/chapter-NNN.json             — De Anima source (18 files)
data/processed/elegia/chapter-NNN.json              — Elegia source (4 files)
data/processed/lombards/chapter-NNN.json            — Lombards source (82 files)
data/processed/regno/chapter-NNN.json               — Regno source (56 files)
data/processed/tongjian/chapter-NNN.json            — Tongjian source (45 files)
data/processed/ptochoprodromos/chapter-NNN.json     — Ptochoprodromos source (2 files)
data/processed/carmina-graeca/chapter-NNN.json      — Carmina Graeca source (21 files)
data/raw/                                           — (gitignored) raw downloads
data/raw/carmina-graeca/                            — 21 clean Greek .txt files (10,957 lines, Grade A quality)
data/raw/sangam/                                    — Cleaned Sangam Tamil texts (Ettuthokai + Pattuppattu)
data/raw/sangam/ettuthokai/akananuru/               — 400/400 poems extracted (COMPLETE)
data/raw/sangam/ettuthokai/purananuru/              — 128/400 poems (rest absent from corpus)
data/raw/sangam/pattuppattu/porunararruppadai/      — 248 lines (COMPLETE)
data/raw/nandikkalambakam/                          — Original + cleaned (114 poems, 641 verse lines)
data/raw/culamani/                                  — Parts 1+3 clean, Part 2 CORRUPTED (needs re-sourcing)
data/raw/yashodhara-kaviyam/                        — COMPLETE (all 5 carukkams, 330 verses)
data/raw/udayanakumara-kaviyam/                     — 367 verses in 6 kandams (related to Perunkathai)
docs/sangam-inspector.md                            — Full corpus inspection report
docs/sangam-scratchpad.md                           — Sangam agent working notes (TBD)
docs/sangam-reference.md                            — Sangam corpus reference/catalog (TBD)

### Config
drizzle.config.ts                                   — Drizzle ORM config
next.config.ts                                      — Next.js config
tailwind.config.ts                                  — Tailwind config
vitest.config.mts                                   — Test config
.env.local                                          — Local env (gitignored)
.env.example                                        — Env template (committed)

### Reference files (for Claude Code sessions)
CLAUDE.md                                           — Project architecture & conventions
scratch-notes.txt                                   — Session-by-session working notes
reference-guide.txt                                 — THIS FILE: structured quick reference
communications-to-the-User.txt                      — Implementation plan & deployment guide

================================================================================
## IMPLEMENTATION STATUS BY PHASE
================================================================================

Phase 1 (Scaffolding):        COMPLETE
Phase 2 (Text Acquisition):   COMPLETE (20 texts, 600+ chapters total)
Phase 3 (Reading UI):          COMPLETE (prose + poetry display modes)
Phase 4 (Editing/Versioning): COMPLETE
Phase 5 (Endorsements):       COMPLETE
Phase 6 (AI Translation):     NEAR COMPLETE (580+ chapters translated; Tongjian + Nandikkalambakam in progress)
Phase 7 (Search/Polish):      PARTIAL (search page exists, SEO metadata added)
Phase 8 (Deployment):         COMPLETE (live at deltoi.com)

Additional features:
- Poetry display mode (line numbers every 5th line, compact spacing)
- Discussion pages (fully implemented: threads, replies, resolve, pin)

================================================================================
## REMAINING WORK (PRIORITY ORDER)
================================================================================

1. Wait for Nandikkalambakam Stage 1 to finish (109/114 done), then launch Stage 3
2. Wait for Tongjian workers to finish (2 workers still running)
3. After Nandikkalambakam: process Yashodhara Kaviyam through full Tamil pipeline
4. After Yashodhara: process Udayanakumara Kaviyam through full Tamil pipeline
5. Commit and push all new processed data + scripts + naming changes
6. Update AUTH_URL on Vercel to https://deltoi.com
7. Sangam Tamil: 15 more canonical works need sourcing from Project Madurai
8. Responsive design polish (mobile stacking for interlinear viewer)
9. Error boundaries and loading skeletons
10. Full-text search improvements (currently basic)
11. Migrate "middleware" to "proxy" convention (Next.js 16 deprecation)
12. Upgrade NextAuth from beta to stable when available
13. Add Ling Shu (靈樞) chapters to HDNJ when user provides raw data

ACTIVE AGENTS (Session 11 — 2026-01-24):
- Tongjian workers: b76003b, b83ad01 — still translating remaining chapters
- Nandikkalambakam Stage 1 (a472c67): translating poems, 109/114 done
- Nandikkalambakam Stage 3: PENDING — launch after Stage 1 completes

COMPLETED RECENTLY:
✓ Naming consistency: all titles now "English Name (Transliteration)" — DB + seed-db.ts updated
✓ Guliang Zhuan: 12/12 COMPLETE (agent ae85d94)
✓ Yi Li: 17/17 COMPLETE (agent a72a764)
✓ Baihu Tong: 43/43 COMPLETE (agent a2d8baa)
✓ Fengsu Tongyi: 11/11 COMPLETE (agent a6a5e09)
✓ Gaoshi Zhuan: 4/4 COMPLETE (agent a451a68)
✓ Yi Zhou Shu: 62/62 COMPLETE with commentary brackets (agent a127b87)
✓ Porunararruppadai editorial clarification v3 (agent a123b07)
✓ Nandikkalambakam Stage 2 Review COMPLETE (agent a28b7f4, B- grade, 64 poems reviewed)

================================================================================
## CONVENTIONS & RULES
================================================================================

1. Schema changes: edit src/server/db/schema.ts, then run `pnpm db:push`
2. Never use migrations in dev — use db:push (schema is already in production via push)
3. Translations are append-only versions — never mutate TranslationVersion rows
4. Paragraph indices must match between source and translation
5. Source texts are immutable after seeding
6. URLs are human-readable slugs: /[lang]/[author]/[text]/[chapter]
7. Chinese text uses Noto Serif CJK font; Greek uses polytonic-capable serif
8. All text content is UTF-8 NFC normalized
9. DeepSeek (not Anthropic/Claude) is the translation API — uses OpenAI SDK
10. Keep scratch-notes.txt and reference-guide.txt updated every session
11. Title naming convention: "English Name (Transliteration)" for ALL languages
    - e.g., "Classified Conversations of Master Zhu (Zhu Zi Yu Lei)"
    - e.g., "The War-Bard's Guide (Porunararruppadai)"
    - Texts with already-English original titles (Latin/Greek) stay as-is: "On the Soul"

================================================================================
## COMMON COMMANDS
================================================================================

# Development
pnpm dev                          # Start dev server (localhost:3000)
pnpm build                        # Production build (also used by Vercel)
pnpm lint                         # ESLint
pnpm typecheck                    # tsc --noEmit

# Database
set -a && source .env.local && set +a   # Load env vars for CLI tools
pnpm db:push                      # Sync schema to Neon
pnpm db:seed                      # Seed texts into DB
pnpm db:studio                    # Drizzle Studio GUI

# Translation
pnpm translate:batch              # Run AI translations (needs DEEPSEEK_API_KEY)

# Git & Deploy
git push origin main              # Triggers Vercel auto-deploy
gh api repos/translorentz/translation-wiki/deployments --jq '.[0]'  # Check deploy

================================================================================
## KNOWN ISSUES
================================================================================

- Next.js 16 "middleware" deprecation warning (non-blocking, still works)
- NextAuth v5 beta (5.0.0-beta.30) — no stable release yet
- AUTH_URL on Vercel may still reference translation-wiki.vercel.app
- Translation workers in progress — ~100+ chapters still being translated
- Discussion pages implemented but not yet tested end-to-end in production
- HDNJ currently only has Su Wen (55 ch); Ling Shu (81 ch) to be added later

================================================================================
## SANGAM TAMIL CORPUS NOTES
================================================================================

Source: data/difficult_extra_processing/tamil_corpus/ (1,768,068 lines, 1000+ files)
Origin: Project Madurai (Tamil Virtual Academy) e-texts
Purpose: Organise and clean for future inclusion in the wiki (NOT for translation yet)

### Source File Format (Project Madurai pattern)
- Lines 1-20: Project info header (title, encoding, credits, copyright notice)
- Content: Tamil verse/prose text with embedded line markers
- End: Footer (colophon, "This page was last updated on..." line)
- Numbers: Standalone integers = poem numbers OR line counts OR in-poem markers (every 5th line)
- Corruptions: Some numbers have spaces inside ("1 5" = 15), OCR artifacts

### Ettuthokai Source Files Found
| Anthology | Corpus File | Status |
|-----------|------------|--------|
| Akananuru | 229_அகநானுறு - மூலம்.txt | 395/400 poems extracted |
| Puranānuru | (TBD — agent searching) | Script written |
| Narrinai | (TBD) | Not yet found |
| Kuruntokai | (TBD) | Not yet found |
| Ainkurunuru | (TBD) | Not yet found |
| Patirruppattu | (TBD) | Not yet found |
| Paripadal | (TBD) | Not yet found |
| Kalittokai | (TBD) | Not yet found |

### Pattuppattu Source Files Found
| Poem | Corpus File | Status |
|------|------------|--------|
| Porunararruppadai | (found) | Extracted |
| Others (9) | (TBD) | Directories created |

### Known Cleaning Challenges
1. Corrupted numbers (spaces inside: "1 5" = 15) — 3 instances in Akananuru
2. End-of-text boundary (last 2 poems merged, colophon/footer leaked)
3. Apparatus markers (.NNN-NN) embedded in verse lines
4. Line markers (multiples of 5) vs poem numbers — disambiguated by context
5. Section headers (numbered Tamil titles) — must be separated from verse
6. Multi-part files: some works split across 2-3 files (பாகம் 1, 2, 3)

### Scripts
| Script | Purpose |
|--------|---------|
| scripts/sangam/clean-akananuru.ts | Tokenizer-based parser, 3-section aware |
| scripts/sangam/clean-puranānuru.ts | Puranānuru processing |
| scripts/sangam/clean-porunar.ts | Porunararruppadai processing |
| scripts/sangam/clean-nandikkalambakam.ts | Strips meter labels, extracts pure verse (114 poems) |

### Output Structure
data/raw/sangam/
├── ettuthokai/
│   ├── akananuru/ (invocation.txt + poem-NNN.txt, 1-400)
│   ├── puranānuru/ (TBD)
│   └── ... (6 more anthologies)
└── pattuppattu/
    ├── porunararruppadai/poem.txt
    ├── tirumurukarruppadai/
    ├── cirupanarruppadai/
    ├── perumpanarruppadai/
    ├── mullaippattu/
    ├── maturaikkanci/
    ├── netunalvatai/
    ├── kurincippattu/
    ├── pattinappalai/
    └── malaipatakatam/

================================================================================
## TRANSLATION PARALLELIZATION NOTES
================================================================================

For large texts (ZZYL 140ch, HDNJ 55ch), split into parallel workers:
  pnpm translate:batch -- --text zhuziyulei --start 58 --end 78 --delay 4000

Key flags:
- --start N / --end N: chapter range
- --delay N: milliseconds between chapters (4000ms per worker when 4+ workers)
- Script auto-skips chapters with existing translations (checks currentVersionId)

Rate limit strategy:
- 1-2 workers: --delay 2000
- 3-4 workers: --delay 4000
- 5+ workers: --delay 5000+

Never pipe translation output through `head` or other truncating commands (SIGPIPE kills process).
