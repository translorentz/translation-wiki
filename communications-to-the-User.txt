User Registration & Usage System — Status Report
==================================================
Date: 2026-01-28

OVERALL STATUS: Substantially complete. Core auth, registration, editing, discussions,
and version history are all implemented, tested, and working. Two features are NOT
implemented: admin user deletion and user self-deletion. Details below.


1. ADDING USERS (Invite-Only Registration)
-------------------------------------------
IMPLEMENTED & TESTED.

- Registration requires a valid invitation token (64-character hex string).
- Tokens are generated by admins from the Admin > Users page.
- Each token is single-use, expires after 7 days, and is consumed atomically
  (race-condition-safe via database transaction).
- A hard cap of 20 users is enforced at registration time.
- Two registration paths:
  a) Email/password: User enters invite token + email + username + password on /register.
  b) Google OAuth: User enters invite token, clicks "Sign in with Google." The token
     is passed via an httpOnly cookie during the OAuth flow.
- Both paths enforce the same token validation and user cap within a single transaction.


2. REVIEWING & LISTING USERS (Admin)
--------------------------------------
IMPLEMENTED & TESTED.

- Admin panel at /admin/users shows all registered users.
- Each user entry displays: username, email, role, registration date.
- User count shown as "N / 20 users registered."
- Invitation Tokens section shows all tokens with status (Active / Used / Expired),
  creator, creation date, expiry date, and a Revoke button for unused tokens.
- Tokens are displayed truncated (first 8 + last 4 chars) for security.


3. REMOVING USERS
------------------
NOT IMPLEMENTED.

- There is no admin UI or API endpoint to delete a user account.
- There is no user self-deletion flow.
- To remove a user today, you would need to run a manual SQL DELETE against the
  database (with cascading deletes on accounts, invitation_tokens references, etc.).
- Recommendation: Implement an admin "deactivate user" endpoint and UI button.


4. WHAT USERS CAN DO (Role-Based Capabilities)
------------------------------------------------
IMPLEMENTED & TESTED.

Three roles exist: "user", "editor", "admin".

| Capability                        | user | editor | admin |
|-----------------------------------|------|--------|-------|
| View all texts and translations   |  Yes |  Yes   |  Yes  |
| Post discussion comments          |  Yes |  Yes   |  Yes  |
| Edit/improve translations         |  No  |  Yes   |  Yes  |
| Endorse translation versions      |  No  |  Yes   |  Yes  |
| Manage users & invitation tokens  |  No  |  No    |  Yes  |
| Change user roles                 |  No  |  No    |  Yes  |

Role changes take effect immediately — the JWT callback refreshes the user's role
from the database on every request.


5. HOW USERS SIGN UP
----------------------
IMPLEMENTED & TESTED.

a) Credentials (email/password):
   - Go to /register
   - Enter invitation token, email, username, password
   - Account is created, token is consumed
   - User is redirected to login page

b) Google OAuth:
   - Go to /register
   - Enter invitation token in the field
   - Click "Sign in with Google"
   - Complete Google sign-in flow
   - Account is created with linked Google account, token is consumed
   - User is logged in automatically

Returning users sign in at /login (credentials or Google button, no token needed).

Edge cases handled:
- Google sign-in with an email that already exists as a credentials account:
  redirected to /login with an error message (no automatic account linking,
  which would be a security risk).
- Expired or already-used token: rejected with clear error message.
- User cap reached: rejected with "maximum number of users" message.


6. HOW USERS REMOVE THEMSELVES
-------------------------------
NOT IMPLEMENTED.

There is no self-service account deletion. Users cannot delete their own accounts
through the UI. This would need to be added as a future feature.


7. PARAMETERS LINKED TO USERS
-------------------------------
IMPLEMENTED.

Each user record stores:
- id (primary key)
- username (unique)
- email (unique)
- passwordHash (nullable — null for Google-only users)
- role ("user" | "editor" | "admin")
- createdAt (timestamp)

Linked records:
- accounts: OAuth provider links (provider, providerAccountId, tokens)
- invitationTokens: which token they used to register (usedByUserId)
- translationVersions: every translation edit they make (authorId)
- discussionThreads: threads they create
- discussionPosts: comments they post
- endorsements: translation versions they endorse


8. DISCUSSION COMMENTS
-----------------------
IMPLEMENTED & TESTED.

- Any logged-in user (any role) can post discussion comments.
- Discussions are per-chapter: each chapter can have multiple threads.
- Each thread has a title and posts. Posts store authorId and creation timestamp.
- Threads and posts are displayed on the chapter page.
- Login is required to post (enforced by protectedProcedure middleware).


9. EDITING TRANSLATED TEXTS
-----------------------------
IMPLEMENTED & TESTED.

- Editors and admins can edit translations via the interlinear viewer.
- Edits are made per-paragraph through an inline editing interface.
- Each edit requires an "edit summary" describing the change.
- Edits create a NEW translation version (never overwrite existing versions).


10. CHANGELOG / VERSION HISTORY
---------------------------------
IMPLEMENTED & TESTED.

- The translation_versions table is append-only. No version is ever deleted or mutated.
- Each version stores:
  - id, translationId, content (full paragraph text)
  - authorId (who made the edit)
  - editSummary (what they changed and why)
  - previousVersionId (links to the prior version, forming a chain)
  - version number (incrementing integer)
  - createdAt timestamp
- The full edit history for any paragraph can be retrieved by following the
  previousVersionId chain back to the original machine translation (version 1).
- Endorsements are version-specific: they point to a specific translationVersion ID,
  so endorsing version 3 does not endorse version 4.


11. TESTING STATUS
-------------------
The following has been verified:

- Schema pushed to production Neon database (accounts, invitation_tokens tables confirmed)
- 8 functional DB smoke tests passed:
  * Token insert and lookup
  * Atomic token consumption
  * Double-consume prevention (second attempt returns empty)
  * Accounts table unique constraint on (provider, providerAccountId)
  * Null passwordHash allowed for Google-only users
  * Transactional registration (token + cap + user creation atomic)
  * Rollback on error (token not consumed if user creation fails)
  * Race condition test (only 1 of 2 concurrent registrations succeeds)
- pnpm build passes cleanly
- Security review completed: 4 High, 4 Medium, 3 Low issues identified and fixed


12. WHAT REMAINS TO BE DONE
-----------------------------
a) Set GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET in production environment variables
   and create OAuth credentials in Google Cloud Console with redirect URI:
   https://deltoi.com/api/auth/callback/google

b) Admin user deletion (not implemented — add if needed)

c) User self-deletion (not implemented — add if needed)

d) User profile page (the getProfile tRPC query exists but there is no /profile page
   for viewing or editing profile details, changing password, etc.)
